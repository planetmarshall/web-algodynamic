---
layout: post
title: Using Merged ResourceDictionaries in Silverlight Themes
tags:
- Silverlight
- Software
status: publish
type: post
published: true
meta:
  dsq_thread_id: '268619506'
---
<p class="pm_first"><span>S</span>ilverlight 3.0 moved its featureset closer to that of WPF by adding support for merged <a href="http://msdn.microsoft.com/en-us/library/cc903952%28VS.95%29.aspx" target="_new">Resource Dictionaries</a> and <a href="http://msdn.microsoft.com/en-us/library/system.windows.style.basedon%28VS.95%29.aspx" target="_new">Style Inheritance</a>. Without these features, developing custom templates and styles for Silverlight controls can become a bit of a copy-and-paste nightmare. Since I have used the implicit theming feature built into the <a href="http://www.codeplex.com/Silverlight" target="_new">Silverlight Toolkit</a> to make my Silverlight controls fit into the overall look and feel of this site, I was hoping that these features would enable me to refactor my themes developed for Silverlight 2.0 to be a bit less unwieldy.</p>

<!--more-->

<h3>Silverlight toolkit themes do not support merged dictionaries</h3>
Unfortunately, merged dictionaries are not supported by the Silverlight Toolkit's Themes feature - at least not as it stands. For example, the following XAML and accompanying class causes a <code>XamlParseException</code> if you try to use it.

<pre lang="xml">
<ResourceDictionary>
 <ResourceDictionary.MergedDictionaries>
  <ResourceDictionary Source="/MergedTheme;component/Styles/Button.xaml"/>
 <ResourceDictionary.MergedDictionaries>
</ResourceDictionary>
</pre>
<pre lang="csharp">
public class MergedTheme : Theme {
 public MergedTheme() : 
  base(typeof(MergedTheme).Assembly, "MergedTheme.Theme.xaml") {
  DefaultStyleKey = typeof(MergedTheme);
 }
}
</pre>

All is not lost however, since full source code is provided for the Silverlight Toolkit, so it becomes a straightforward matter to track down the problem and supply a patch. 
<h3>Writing a test to reproduce the problem</h3>
Since the toolkit comes with an accompanying test suite, we proceed in textbook <a href="http://en.wikipedia.org/wiki/Test-driven_development" target="_new">TDD</a> fashion by first writing a test that exercises the issue. We can reuse some of the existing code to do this, adding a resource dictionary containing a merged dictionary reference and adding the following test to the <code>ImplicitStyleManagerTest</code> class

<pre lang="csharp">
/// <summary>
/// Test that styles contained in a  merged dictionary can be successfully applied
/// </summary>
[TestMethod]
[Asynchronous]
[Description("Test that a dictionary contining merged dictionaries can be successfully loaded.")]
public void TestResourceDictionaryWithMergedDictionaries() {
 Uri uri = new Uri("System.Windows.Controls.Testing.Theming;
  component/ImplicitStyleManager/MergedResourceDictionary.xaml", UriKind.Relative);
 TestAuto( (stackPanel) => {
  SetResourceDictionaryUri(stackPanel, uri);
  ImplicitStyleManager.SetApplyMode(stackPanel, ImplicitStylesApplyMode.Auto);
  }, Colors.Blue);
}
</pre>
The test fails as we would expect.

[singlepic id=70 template=figure]
<h3>Fix the code to make the test pass</h3>
The Theme class works by transforming the<code> ResourceDictionary</code> xaml into a <code>ContentControl</code>. A quick glance at the xaml generated by this process in the Visual Studio debugger shows why an exception is being raised.
<pre lang="xml">
<ContentControl>
 <ContentControl.Resources>
  <ResourceDictionary.MergedDictionaries>
   <ResourceDictionary Source="[...]/ResourceDictionaryForMerge.xaml" /> 
  </ResourceDictionary.MergedDictionaries>
 </ContentControl.Resources>
</ContentControl>
</pre>

The <code>ResourceDictionary.MergedDictionaries</code> element is missing its parent <code>ResourceDictionary</code> element, so we add a couple of lines of code to ResourceParser.ParseElement to detect the element and wrap it in a <code>ResourceDictionary</code>, using LINQ to XML.

<pre lang="csharp">
private static void ParseElement(XmlReader reader, XmlWriter writer, bool checkTypes) {
 if (reader.Depth == 0) {...}
 else {
  // handle merged dictionaries by wrapping them in a ResourceDictionary element
  if (reader.Name == "ResourceDictionary.MergedDictionaries") {
   XElement parent = new XElement("ResourceDictionary");
   parent.Add(XElement.ReadFrom(reader));
   writer.WriteRaw(parent.ToString());
  }
  else { ... }
 }   
}         
</pre>
Having made the change, we rerun the test.

[singlepic id=71 template=figure]

As we would hope, our custom theme now works as expected and we also have a unit test that ensures the bug does not reoccur. Note the Xaml code above, in that the Resource Dictionary is referenced using <a href="http://msdn.microsoft.com/en-us/library/aa970069.aspx" target="_new">Pack Uri</a> syntax. This is because <code>Button.xaml</code> is compiled as a Resource, rather than Content, since the latter doesn't appear to work reliably and can result in obfuscated error messages such as <i>XamlParseException: attribute "Button.xaml" value out of range.</i>

[singlepic id=72 template=figure]

I have submitted the patch for this fix to the toolkit site on Codeplex.
